# API Reference

Complete REST API documentation for the CloudLeecher backend.

## Base URL

The backend API is accessed through the ngrok URL generated by your Google Colab session:

```
https://your-unique-ngrok-url.ngrok-free.dev
```

## Headers

All requests should include:

```http
Content-Type: application/json
ngrok-skip-browser-warning: true
```

---

## Endpoints

### Health Check

**GET** `/health`

Check if the backend is running and accessible.

**Response:**
```json
{
  "status": "ok",
  "service": "CloudLeecher-Backend"
}
```

**Status Codes:**
- `200 OK` - Backend is healthy

---

### Get Backend Logs

**GET** `/api/logs`

Retrieve recent backend operation logs (last 100 entries).

**Response:**
```json
{
  "logs": [
    {
      "timestamp": "2026-01-22T17:30:15.123456",
      "level": "info",
      "operation": "add_magnet",
      "message": "Magnet link added successfully",
      "gid": "1234567890abcdef",
      "extra": {
        "magnet": "magnet:?xt=urn:btih:..."
      }
    }
  ]
}
```

**Log Levels:**
- `info` - Normal operations
- `warning` - Non-critical issues
- `error` - Failures and errors

**Status Codes:**
- `200 OK` - Logs retrieved successfully
- `500 Internal Server Error` - Failed to retrieve logs

---

### Add Magnet Link

**POST** `/api/download/magnet`

Add a torrent download via magnet link.

**Request Body:**
```json
{
  "magnet": "magnet:?xt=urn:btih:HASH&dn=Name&tr=tracker1&tr=tracker2"
}
```

**Response (Success):**
```json
{
  "status": "success",
  "gid": "1234567890abcdef"
}
```

**Response (Queue Full):**
```json
{
  "error": "Another download is already in progress. Please wait for it to complete."
}
```

**Status Codes:**
- `200 OK` - Download added successfully
- `400 Bad Request` - Missing or invalid magnet link
- `429 Too Many Requests` - Another download is already active
- `500 Internal Server Error` - Aria2 error

**Notes:**
- Only one download can be active at a time
- The `gid` (Global Identifier) is used to track the download

---

### Add Torrent File

**POST** `/api/download/file`

Add a torrent download via .torrent file.

**Request Body:**
```json
{
  "torrent": "base64_encoded_torrent_file_content"
}
```

**Response (Success):**
```json
{
  "status": "success",
  "gid": "1234567890abcdef"
}
```

**Response (Queue Full):**
```json
{
  "error": "Another download is already in progress. Please wait for it to complete."
}
```

**Status Codes:**
- `200 OK` - Download added successfully
- `400 Bad Request` - Missing or invalid torrent file
- `429 Too Many Requests` - Another download is already active
- `500 Internal Server Error` - Aria2 error

**Notes:**
- Torrent file must be base64 encoded
- The backend decodes and passes binary data to Aria2

---

### Get Download Status

**GET** `/api/status`

Get status of all downloads (active, waiting, stopped).

**Response:**
```json
{
  "active": [
    {
      "gid": "1234567890abcdef",
      "status": "active",
      "totalLength": "1073741824",
      "completedLength": "536870912",
      "downloadSpeed": "5242880",
      "uploadSpeed": "0",
      "numSeeders": "15",
      "connections": "8",
      "dir": "/content/drive/MyDrive/TorrentDownloads",
      "files": [
        {
          "index": "1",
          "path": "/content/drive/MyDrive/TorrentDownloads/file.mp4",
          "length": "1073741824",
          "completedLength": "536870912",
          "selected": "true"
        }
      ],
      "bittorrent": {
        "info": {
          "name": "file.mp4"
        }
      },
      "infoHash": "abcdef1234567890",
      "followedBy": [],
      "following": ""
    }
  ],
  "waiting": [],
  "stopped": []
}
```

**Field Descriptions:**

| Field | Type | Description |
|-------|------|-------------|
| `gid` | string | Global Identifier for the download |
| `status` | string | `active`, `waiting`, `paused`, `error`, `complete`, `removed` |
| `totalLength` | string | Total file size in bytes |
| `completedLength` | string | Downloaded bytes |
| `downloadSpeed` | string | Current download speed (bytes/sec) |
| `uploadSpeed` | string | Current upload speed (bytes/sec) |
| `numSeeders` | string | Number of seeders (active only) |
| `connections` | string | Active peer connections |
| `dir` | string | Download directory path |
| `files` | array | Array of files in the torrent |
| `bittorrent.info.name` | string | Torrent name |
| `infoHash` | string | Torrent info hash |
| `errorMessage` | string | Error description (if status is `error`) |
| `errorCode` | string | Error code (if status is `error`) |
| `followedBy` | array | GIDs of tasks this task spawned |
| `following` | string | GID of task this task is following |

**Status Codes:**
- `200 OK` - Status retrieved successfully
- `500 Internal Server Error` - Failed to query Aria2

**Notes:**
- Poll this endpoint every 2-3 seconds for real-time updates
- `followedBy` and `following` track GID transitions (metadata â†’ download)

---

### Pause Download

**POST** `/api/control/pause`

Pause an active download.

**Request Body:**
```json
{
  "gid": "1234567890abcdef"
}
```

**Response:**
```json
{
  "status": "paused",
  "gid": "1234567890abcdef"
}
```

**Status Codes:**
- `200 OK` - Download paused successfully
- `500 Internal Server Error` - Failed to pause

---

### Resume Download

**POST** `/api/control/resume`

Resume a paused download.

**Request Body:**
```json
{
  "gid": "1234567890abcdef"
}
```

**Response:**
```json
{
  "status": "resumed",
  "gid": "1234567890abcdef"
}
```

**Status Codes:**
- `200 OK` - Download resumed successfully
- `500 Internal Server Error` - Failed to resume

---

### Remove Download

**POST** `/api/control/remove`

Remove a download (active, waiting, or stopped).

**Request Body:**
```json
{
  "gid": "1234567890abcdef"
}
```

**Response:**
```json
{
  "status": "removed",
  "gid": "1234567890abcdef"
}
```

**Status Codes:**
- `200 OK` - Download removed successfully
- `500 Internal Server Error` - Failed to remove

**Notes:**
- Uses `forceRemove` to stop even active downloads
- Returns success even if GID not found (idempotent)

---

### Get Drive Info

**GET** `/api/drive/info`

Get Google Drive storage information.

**Response:**
```json
{
  "total": 16106127360,
  "used": 5368709120,
  "free": 10737418240
}
```

**Field Descriptions:**

| Field | Type | Description |
|-------|------|-------------|
| `total` | number | Total storage in bytes |
| `used` | number | Used storage in bytes |
| `free` | number | Free storage in bytes |

**Status Codes:**
- `200 OK` - Storage info retrieved

**Notes:**
- Returns zeros if unable to query storage

---

### Cleanup All Tasks

**POST** `/api/cleanup`

Remove ALL tasks from Aria2 (nuclear option).

**Request Body:**
```json
{}
```

**Response:**
```json
{
  "status": "success",
  "removed": 5
}
```

**Status Codes:**
- `200 OK` - Cleanup completed
- `500 Internal Server Error` - Cleanup failed

**Notes:**
- Force removes all active and waiting tasks
- Purges all stopped tasks
- Use when frontend and backend are out of sync

---

## Error Responses

All endpoints may return error responses in this format:

```json
{
  "error": "Error description"
}
```

Common error status codes:
- `400 Bad Request` - Invalid input data
- `429 Too Many Requests` - Queue limit reached
- `500 Internal Server Error` - Backend or Aria2 failure

---

## Rate Limiting

**Status Polling:**
- Recommended: 2-3 seconds between requests
- Avoid polling faster than 1 second

**Download Requests:**
- Limited to 1 active download at a time
- Enforced at backend level

---

## Example Usage

### Add Magnet Link (JavaScript)

```javascript
import axios from 'axios';

const API_URL = 'https://your-ngrok-url.ngrok-free.dev';

async function addMagnetLink(magnetUrl) {
  try {
    const response = await axios.post(
      `${API_URL}/api/download/magnet`,
      { magnet: magnetUrl },
      {
        headers: {
          'Content-Type': 'application/json',
          'ngrok-skip-browser-warning': 'true'
        }
      }
    );
    console.log('Download added:', response.data.gid);
    return response.data.gid;
  } catch (error) {
    console.error('Failed to add magnet:', error.response?.data?.error);
    throw error;
  }
}
```

### Poll Download Status (JavaScript)

```javascript
async function pollStatus() {
  const response = await axios.get(`${API_URL}/api/status`, {
    headers: { 'ngrok-skip-browser-warning': 'true' }
  });
  
  const { active, waiting, stopped } = response.data;
  
  active.forEach(task => {
    const progress = (parseInt(task.completedLength) / parseInt(task.totalLength)) * 100;
    const speedMBps = (parseInt(task.downloadSpeed) / 1024 / 1024).toFixed(2);
    console.log(`${task.bittorrent.info.name}: ${progress.toFixed(1)}% @ ${speedMBps} MB/s`);
  });
}

// Poll every 2 seconds
setInterval(pollStatus, 2000);
```

### Add Torrent File (JavaScript)

```javascript
async function addTorrentFile(file) {
  // Read file as base64
  const reader = new FileReader();
  const base64 = await new Promise((resolve, reject) => {
    reader.onload = () => {
      const b64 = reader.result.split(',')[1];
      resolve(b64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
  
  // Send to backend
  const response = await axios.post(
    `${API_URL}/api/download/file`,
    { torrent: base64 },
    {
      headers: {
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true'
      }
    }
  );
  
  return response.data.gid;
}
```

---

## Aria2 RPC Integration

The backend communicates with Aria2 using XML-RPC protocol. Key Aria2 methods used:

| Backend Operation | Aria2 RPC Method | Description |
|-------------------|------------------|-------------|
| Add magnet | `aria2.addUri([magnet])` | Add magnet link |
| Add torrent | `aria2.addTorrent(binary)` | Add .torrent file |
| Get status | `aria2.tellStatus(gid, keys)` | Get single task status |
| Get active | `aria2.tellActive(keys)` | Get all active tasks |
| Get waiting | `aria2.tellWaiting(offset, num, keys)` | Get waiting tasks |
| Get stopped | `aria2.tellStopped(offset, num, keys)` | Get stopped tasks |
| Pause | `aria2.pause(gid)` | Pause download |
| Resume | `aria2.unpause(gid)` | Resume download |
| Remove | `aria2.forceRemove(gid)` | Force remove task |
| Purge | `aria2.purgeDownloadResult()` | Clear stopped tasks |

For more information on Aria2 RPC, see the [Aria2 RPC Documentation](https://aria2.github.io/manual/en/html/aria2c.html#rpc-interface).
